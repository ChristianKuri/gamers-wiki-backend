# docker-compose.yml (ARM64 Production Version)

version: '3.8'

services:
  strapi:
    container_name: gamers-wiki-strapi
    # This tells Docker to build a native ARM64 image
    platform: linux/arm64
    # This builds the image from the Dockerfile in this directory
    build: .
    restart: unless-stopped
    env_file: .env
    environment:
      DATABASE_CLIENT: postgres
      DATABASE_HOST: db
      DATABASE_PORT: 5432
      DATABASE_SSL: 'false'
      HOST: '0.0.0.0'
      PORT: 1337
      NODE_ENV: production
    ports:
      - "1337:1337"
    depends_on:
      - db

  db:
    container_name: gamers-wiki-postgres
    # This ensures the ARM64 version of Postgres is used
    platform: linux/arm64
    image: postgres:14-alpine
    restart: unless-stopped
    env_file: .env
    environment:
      POSTGRES_DB: ${DATABASE_NAME}
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
    volumes:
      # Persists the database data on your server in a folder named 'strapi-data'
      - ./strapi-data:/var/lib/postgresql/data
    ports:
      # Optional: Exposes the database port. You can remove this for better security.
      - "5432:5432"

  strapi_db_backup:
    container_name: gamers-wiki-db-backup
    # This ensures the ARM64 version of the backup tool is used
    platform: linux/arm64
    image: tiredofit/db-backup
    restart: unless-stopped
    env_file: .env
    environment:
      - CONTAINER_ENABLE_MONITORING=FALSE
      - DB_TYPE=postgres
      - DB_HOST=db
      - DB_DUMP_FREQ=1440 # Backs up once every 24 hours
      - BACKUP_LOCATION=S3
      - S3_PATH=${S3_PATH_BACKUP}
    depends_on:
      - db